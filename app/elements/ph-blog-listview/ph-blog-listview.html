<link rel="import" href="../../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../../bower_components/core-list/core-list.html">

<!--
This component requests data from a given feed and lists them in a listview powered by `<core-list>`. You provide a
custom parse function which is used to parse your feed data. This can either be of type xml or json.

Two predefined views are available to choose from.

##### Example

    <ph-blog-listview ></ph-blog-listview>

@group Components Examples
@element ph-blog-listview
@status alpha
@homepage http://silentHoo.github.io/ph-blog-listview
-->
<polymer-element name="ph-blog-listview" attributes="feed handleAs viewType filterBy">
  <template>
    <link rel="stylesheet" href="ph-blog-listview.css">

    <core-ajax id="ajax" auto url="{{feed}}" handleAs="{{handleAs}}" on-core-complete="{{requestCompleted}}"></core-ajax>

    <!--<div id="scroller" style="overflow:auto; width: 100%; height: 200px" fit>-->
      <!-- template 'default' -->
      <template if="{{ (viewType == 'default' || !viewType) && _entries.length > 0 }}">
          <!-- make sure you are 'fit' the given space! -->
          <core-list id="core-list" data="{{ _entries }}" fit>
            <template>
              <div id="view-default" horizontal layout>
                <div class="preview" vertical layout start one>
                  <img src="http://lorempixel.com/200/200/">
                </div>
                <div class="content" flex>
                  <div vertical layout>
                    <div class="title">Titel</div>
                    <div class="subtitle"><span class="date">Datum</span>, <span class="category">Kategorie</span></div>
                    <div class="description">Inhalt</div>
                  </div>
                </div>
              </div>
            </template>
          </core-list>
      </template>

      <!-- template 'compact' -->
      <template if="{{viewType == 'compact'}}">
        compact
      </template>

      <!-- template 'custom' -->
      <template id="view-type-custom">
        <!-- siehe bei core-list -->
      </template>
    <!--</div>-->
  </template>

  <script>
    Polymer({
      publish: {
        /**
         * The `feed` attribute sets the json or xml format list which is requested via XMLHTTPRequest
         * from the remote server.
         *
         * Note: CORS must properly be configured.
         *
         * @attribute feed
         * @type string
         * @default ''
         */
        feed: '',

        /**
         * The `handleAs` attribute sets the format for the given feed. Valid inputs are `xml` and `json`.
         *
         * @attribute handleAs
         * @type string
         * @default 'json'
         */
        handleAs: '',

        /**
         * The `default` attribute sets the used view which is represented by the component.
         *
         * @attribute feed
         * @type string
         * @default 'default'
         */
        viewType: 'default',

        /**
         * The `filterBy` attribute specifies which attribute of the parsed feed array is used to filter by
         * `filterValue`.
         *
         * @attribute filterBy
         * @type string
         * @default ''
         */
        filterBy: '',

        /**
         * The `filterValue` attribute specifies the value for the `filterBy` set attribute.
         *
         * @attribute filterValue
         * @type string
         * @default ''
         */
        filterValue: ''
      },

      // *** private variables ***
      _responseParseFunc: null,
      _entries: [],

      // *** lifecycle callbacks ***
      ready: function () {
        // Ready is a lifecycle callback.
        // You can do setup work in here.
        // More info: http://www.polymer-project.org/docs/polymer/polymer.html#lifecyclemethods
      },

      /**
       * This function sets the custom function defined by the consumer to parse the xml or json document
       * properly. This function *must* return an array with the attributes `` for each object that's contained.
       *
       * @method setResponseParseFunc
       * @param func the function which parses the response
       */
      setResponseParseFunc: function(func) {
        this._responseParseFunc = func;
      },

      requestCompleted: function(event, detail, sender) {
        var response;
        switch (this.handleAs) {
          case 'xml':
            response = detail.xhr.responseXML;
            break;
          case 'json':
            response = detail.xhr.response;
            break;
        }

        this._proceedResponse(response);
      },

      // *** private methods ***

      _proceedResponse: function(response) {
        this._entries = this._responseParseFunc(response);
      }
    });
  </script>
</polymer-element>
